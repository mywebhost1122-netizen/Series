<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Buzz - ओनर पैनल</title>
    <style>
        :root { --primary: #E50914; --secondary: #222; --background: #141414; --text-primary: #fff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--background); color: var(--text-primary); }
        .view { display: none; padding: 20px; padding-bottom: 100px; }
        .view.active { display: block; }
        .container { max-width: 1200px; margin: auto; }
        button { cursor: pointer; padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; transition: background-color 0.3s; }
        .btn-primary { background-color: var(--primary); color: var(--text-primary); width: 100%; }
        .btn-secondary { background-color: #444; color: var(--text-primary); margin-top: 10px; width: 100%; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        header h1 { font-size: 28px; }
        .btn-back { font-size: 28px; background: none; border: none; color: var(--text-primary); padding-right: 15px; }
        .list-section { background-color: var(--secondary); padding: 20px; border-radius: 8px; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 4px; }
        .list-item:nth-child(even) { background-color: #2a2a2a; }
        .list-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
        .list-item-actions button { background: none; border: none; color: #aaa; margin-left: 15px; padding: 5px; display: inline-flex; align-items: center; justify-content: center; }
        .list-item-actions button svg { width: 20px; height: 20px; }
        .list-item-actions button:hover { color: var(--primary); }
        .btn-change-text { background-color: #444; color: white; font-size: 14px; padding: 5px 10px; border-radius: 4px; }
        .list-item-details { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; padding-right: 10px; }
        .list-item-details .current-btn-text { font-size: 12px; color: #ccc; margin-top: 4px; }
        #form-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background); z-index: 1500; overflow-y: auto; display: none; }
        #form-view .form-container { padding: 20px; padding-bottom: 80px; }
        #form-view .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #form-view h2 { font-size: 24px; }
        #form-view .btn-close-form { font-size: 28px; background: none; border: none; color: var(--text-primary); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--secondary); padding: 25px; border-radius: 8px; width: 95%; max-width: 400px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 28px; background: none; border: none; color: var(--text-primary); }
        #add-choice-modal .choice-buttons { display: flex; flex-direction: column; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 4px; border: 1px solid #444; background-color: #333; color: var(--text-primary); font-size: 16px; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .bottom-action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--secondary); display: flex; justify-content: space-evenly; align-items: center; height: 60px; padding: 0 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); z-index: 500; }
        .bar-icon { background: none; border: none; color: #aaa; display: flex; flex-direction: column; align-items: center; font-size: 12px; gap: 4px; flex-grow: 1; height: 100%; justify-content: center; }
        .bar-icon.active { color: var(--primary); }
        .bar-icon svg { width: 24px; height: 24px; }
        .fab { width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary); color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.4); position: fixed; bottom: 75px; left: 50%; transform: translateX(-50%); z-index: 501; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 15px; padding: 20px; }
        .color-swatch { width: 100%; aspect-ratio: 1/1; border-radius: 50%; cursor: pointer; border: 2px solid #555; transition: transform 0.2s, box-shadow 0.2s; }
        .color-swatch:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--primary); }
        .comment-card { display: flex; align-items: center; padding: 12px; border-radius: 4px; cursor: pointer; }
        .comment-card:nth-child(even) { background-color: #2a2a2a; }
        .comment-card-poster { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        #comments-list-owner { padding-bottom: 80px; }
        .comment-item { display: flex; flex-direction: column; margin-bottom: 15px; padding: 10px; background-color: #2a2a2a; border-radius: 8px; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .comment-author { font-weight: bold; }
        .comment-item.owner .comment-author { color: var(--primary); }
        .owner-icon { font-size: 16px; margin-left: 5px; }
        .comment-delete-btn { background: none; border: none; color: #aaa; cursor: pointer; }
        #reply-area { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; padding: 15px; border-top: 1px solid #333; background-color: #181818; z-index: 1600; }
        .reply-input { flex-grow: 1; padding: 10px; background-color: #2c2c2c; border: 1px solid #555; border-radius: 20px; color: var(--text-primary); font-size: 15px; margin-right: 10px; }
        .send-reply-btn { padding: 10px 15px; background-color: var(--primary); border: none; border-radius: 20px; color: var(--text-primary); font-weight: bold; cursor: pointer; }
        #admin-stats, #anime-stats, #banner-stats { font-size: 18px; color: #ccc; }
    </style>
</head>
<body>
    <div id="banners-view" class="view active">
        <div class="container">
            <header>
                <h1>Banners</h1>
                <div id="banner-stats"></div>
            </header>
            <div class="list-section">
                <div id="animeBanners-list"></div>
            </div>
        </div>
    </div>
    <div id="anime-view" class="view">
        <div class="container">
            <header>
                <h1>Anime</h1>
                <div id="anime-stats"></div>
            </header>
            <div class="list-section">
                <div id="anime-list"></div>
            </div>
        </div>
    </div>
    <div id="updates-view" class="view"><div class="container"><header><h1>Updates</h1></header><div class="list-section"><div id="updates-list"></div></div></div></div>
    <div id="settings-view" class="view"><div class="container"><header><h1>Button Settings</h1></header><h2 style="margin-bottom: 15px;">Banners</h2><div class="list-section" style="margin-bottom: 30px;"><div id="banner-settings-list"></div></div><h2 style="margin-bottom: 15px;">Anime</h2><div class="list-section"><div id="anime-settings-list"></div></div></div></div>
    <div id="color-picker-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Change Button Color</h1><div></div></header><div class="color-grid" id="color-grid"></div></div></div>
    <div id="background-form-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Change Background</h1><div></div></header><form id="background-form"><div class="form-group"><label for="backgroundUrlInput">Background Image URL</label><input type="url" id="backgroundUrlInput" placeholder="https://example.com/image.jpg" required></div><button type="submit" class="btn-primary">Save Background</button><button type="button" class="btn-secondary" onclick="resetBackground()">Reset to Default</button></form></div></div>
    <div id="manage-comment-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Manage Comments</h1><div></div></header><div class="list-section"><div id="comment-anime-list"></div></div></div></div>
    <div id="comment-details-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView('manage-comment-view')">&lt;</button><h1 id="comment-anime-title" style="font-size: 22px;"></h1><div></div></header><div id="comments-list-owner"></div></div><div id="reply-area"><input type="text" id="replyInput" class="reply-input" placeholder="Type a reply..."><button id="sendReplyBtn" class="send-reply-btn">Reply</button></div></div>
    <div id="manage-admins-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Total Admins</h1><div></div></header><div id="admin-stats" style="text-align: center; margin-bottom: 20px;"></div><div class="list-section"><div id="admins-list"></div></div></div></div>
    <div id="website-name-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Change Website Name</h1><div></div></header><form id="website-name-form"><div class="form-group"><label for="websiteNameInput">Website Name</label><input type="text" id="websiteNameInput" placeholder="Enter new name" required></div><button type="submit" class="btn-primary">Save Change</button><button type="button" class="btn-secondary" onclick="resetWebsiteName()">Reset to Default</button></form></div></div>
    <div id="title-color-picker-view" class="view"><div class="container"><header><button class="btn-back" onclick="switchView(lastActiveView)">&lt;</button><h1>Change Title Colour</h1><div></div></header><div class="color-grid" id="title-color-grid"></div></div></div>
    <div id="form-view"><div class="form-container container"><div class="form-header"><h2 id="form-title"></h2><button class="btn-close-form" onclick="closeForm()">×</button></div><form id="main-form"><input type="hidden" id="docId"><input type="hidden" id="collectionName"><div class="form-group"><label for="title">Title</label><input type="text" id="title"></div><div class="form-group"><label for="imageUrl" id="imageUrlLabel">Image URL</label><input type="url" id="imageUrl"></div><div class="form-group"><label for="category">Category</label><input type="text" id="category"></div><div class="form-group"><label for="description">Description</label><textarea id="description"></textarea></div><div class="form-group"><label for="language">Language</label><input type="text" id="language"></div><div class="form-group"><label for="channelBotLink">Channel Link</label><input type="url" id="channelBotLink"></div><button type="submit" class="btn-primary" style="margin-top: 20px;">Save</button></form></div></div>
    <div id="add-choice-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Options</h2><button class="close-btn" onclick="hideAddChoice()">×</button></div><div class="choice-buttons"><button class="btn-primary" onclick="openManageComments()">Manage Comment</button><button class="btn-primary" onclick="openManageAdmins()">Total Admins</button><button class="btn-primary" onclick="showNameChangeForm()">Change Website Name</button><button class="btn-primary" onclick="showTitleColorPicker()">Change Web Title Colour</button><button class="btn-primary" onclick="openForm('updates')">Add Update</button><button class="btn-primary" onclick="openForm('anime')">Add Anime</button><button class="btn-primary" onclick="openForm('animeBanners')">Add Banner</button><button class="btn-primary" onclick="showColorPicker()">Change Button Color</button><button class="btn-primary" onclick="showBackgroundForm()">Change Background Wallpaper</button></div></div></div>
    <nav class="bottom-action-bar"><button id="nav-banners" class="bar-icon active" onclick="switchView('banners-view')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg><span>Banners</span></button><button id="nav-anime" class="bar-icon" onclick="switchView('anime-view')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg><span>Anime</span></button><button class="fab" onclick="showAddChoice()">+</button><button id="nav-updates" class="bar-icon" onclick="switchView('updates-view')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12h2.5"/><path d="M19.5 7.5c-1.342-2.13-3.42-3.5-5.5-3.5-3.038 0-6.5 2.462-6.5 5.5s3.462 6.5 6.5 6.5c2.08 0 4.158-1.37 5.5-3.5"/><path d="M12.5 8H12v6h6"/></svg><span>Updates</span></button><button id="nav-settings" class="bar-icon" onclick="switchView('settings-view')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span>Settings</span></button></nav>
    <div id="loader"><div class="spinner"></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyASOG_iJLTolJHK54Z4BpLpAimA4JALURY", authDomain: "animeweb-b9a7b.firebaseapp.com", projectId: "animeweb-b9a7b", storageBucket: "animeweb-b9a7b.firebasestorage.app", messagingSenderId: "920902736319", appId: "1:920902736319:web:b0dff9ec9e298021bf290a" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const mainForm = document.getElementById('main-form');
        const loader = document.getElementById('loader');
        const titleInput = document.getElementById('title');
        const imageUrlInput = document.getElementById('imageUrl');
        const descriptionInput = document.getElementById('description');
        let lastActiveView = 'banners-view';
        let currentCommentListener = null;

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const specialViews = ['color-picker-view', 'background-form-view', 'manage-comment-view', 'comment-details-view', 'manage-admins-view', 'website-name-view', 'title-color-picker-view'];
            if (!specialViews.includes(viewId)) {
                lastActiveView = viewId;
                document.querySelectorAll('.bar-icon').forEach(i => i.classList.remove('active'));
                const navIconId = `nav-${viewId.split('-')[0]}`;
                if (document.getElementById(navIconId)) document.getElementById(navIconId).classList.add('active');
            }
        }
        async function openForm(collection, mode = 'add', docId = null) {
            hideAddChoice(); mainForm.reset();
            document.getElementById('docId').value = docId; document.getElementById('collectionName').value = collection;
            titleInput.required = false; imageUrlInput.required = false; descriptionInput.required = false;
            document.querySelectorAll('#main-form .form-group').forEach(group => group.style.display = 'none');
            let formTitle = ''; document.getElementById('imageUrlLabel').innerText = 'Image URL';
            if (collection === 'anime' || collection === 'animeBanners') { formTitle = `${mode === 'edit' ? 'Edit' : 'Add New'} ${collection === 'anime' ? 'Anime' : 'Banner'}`; document.querySelectorAll('#title, #imageUrl, #description, #channelBotLink').forEach(el => el.parentElement.style.display = 'block'); titleInput.required = true; imageUrlInput.required = true; if (collection === 'anime') { document.querySelectorAll('#category, #language').forEach(el => el.parentElement.style.display = 'block'); }
            } else if (collection === 'updates') { formTitle = `${mode === 'edit' ? 'Edit' : 'Add New'} Update`; document.querySelectorAll('#title, #imageUrl, #description').forEach(el => el.parentElement.style.display = 'block'); document.getElementById('imageUrlLabel').innerText = 'Banner URL'; imageUrlInput.required = true; descriptionInput.required = true; }
            document.getElementById('form-title').innerText = formTitle;
            if (mode === 'edit' && docId) {
                loader.style.display = 'flex';
                const doc = await db.collection(collection).doc(docId).get();
                if (doc.exists) {
                    const data = doc.data(); titleInput.value = data.title || ''; descriptionInput.value = data.description || '';
                    if (collection === 'updates') { imageUrlInput.value = data.bannerUrl || ''; } 
                    else { imageUrlInput.value = data.imageUrl || ''; document.getElementById('channelBotLink').value = data.episodeLink || ''; }
                    if (collection === 'anime') { document.getElementById('category').value = data.category || ''; document.getElementById('language').value = data.language || ''; }
                }
                loader.style.display = 'none';
            }
            document.getElementById('form-view').style.display = 'block';
        }
        mainForm.addEventListener('submit', async (e) => {
            e.preventDefault(); loader.style.display = 'flex';
            const collection = document.getElementById('collectionName').value; const docId = document.getElementById('docId').value; let data;
            if (collection === 'updates') { data = { title: titleInput.value, bannerUrl: imageUrlInput.value, description: descriptionInput.value, timestamp: firebase.firestore.FieldValue.serverTimestamp() }; } 
            else { data = { title: titleInput.value, imageUrl: imageUrlInput.value, description: descriptionInput.value, episodeLink: document.getElementById('channelBotLink').value }; if (collection === 'anime') { data.category = document.getElementById('category').value; data.language = document.getElementById('language').value; } }
            try { if (docId) { await db.collection(collection).doc(docId).set(data, { merge: true }); } else { await db.collection(collection).add(data); } closeForm(); } 
            catch (err) { alert(err.message); } finally { loader.style.display = 'none'; }
        });
        function closeForm() { document.getElementById('form-view').style.display = 'none'; switchView(lastActiveView); fetchAllData(); }
        function showAddChoice() { document.getElementById('add-choice-modal').classList.add('active'); }
        function hideAddChoice() { document.getElementById('add-choice-modal').classList.remove('active'); }
        const colors = [ "#E50914", "#F44336", "#E91E63", "#9C27B0", "#673AB7", "#3F51B5", "#2196F3", "#00BCD4", "#009688", "#4CAF50", "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800", "#FF5722", "#795548", "#9E9E9E", "#607D8B", "#FFFFFF" ];
        const buttonColorGrid = document.getElementById('color-grid'); const titleColorGrid = document.getElementById('title-color-grid');
        colors.forEach(color => {
            const swatch1 = document.createElement('div'); swatch1.className = 'color-swatch'; swatch1.style.backgroundColor = color; swatch1.onclick = () => selectColor(color); buttonColorGrid.appendChild(swatch1);
            const swatch2 = document.createElement('div'); swatch2.className = 'color-swatch'; swatch2.style.backgroundColor = color; swatch2.onclick = () => selectTitleColor(color); titleColorGrid.appendChild(swatch2);
        });
        async function showNameChangeForm() { hideAddChoice(); loader.style.display = 'flex'; try { const doc = await db.collection('siteConfig').doc('main').get(); if (doc.exists && doc.data().websiteName) { document.getElementById('websiteNameInput').value = doc.data().websiteName; } else { document.getElementById('websiteNameInput').value = 'AnimeBuzz'; } } catch (err) { console.error("Error fetching website name:", err); } finally { loader.style.display = 'none'; } switchView('website-name-view'); }
        document.getElementById('website-name-form').addEventListener('submit', async (e) => { e.preventDefault(); const newName = document.getElementById('websiteNameInput').value.trim(); if (!newName) { alert("Website name cannot be empty."); return; } loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ websiteName: newName }, { merge: true }); alert('Website name updated successfully!'); switchView(lastActiveView); } catch (err) { alert('Error updating name: ' + err.message); } finally { loader.style.display = 'none'; } });
        async function resetWebsiteName() { if (confirm("Are you sure you want to reset the name to 'AnimeBuzz'?")) { loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ websiteName: "AnimeBuzz" }, { merge: true }); document.getElementById('websiteNameInput').value = "AnimeBuzz"; alert('Website name has been reset.'); switchView(lastActiveView); } catch (err) { alert('Error resetting name: ' + err.message); } finally { loader.style.display = 'none'; } } }
        function showTitleColorPicker() { hideAddChoice(); switchView('title-color-picker-view'); }
        async function selectTitleColor(hexCode) { loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ titleColor: hexCode }, { merge: true }); alert('Title colour updated successfully!'); switchView(lastActiveView); } catch (err) { alert('Error updating title colour: ' + err.message); } finally { loader.style.display = 'none'; } }
        function showColorPicker() { hideAddChoice(); switchView('color-picker-view'); }
        async function selectColor(hexCode) { loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ primaryColor: hexCode }, { merge: true }); applyThemeColor(hexCode); alert('Color updated successfully!'); switchView(lastActiveView); } catch (err) { alert('Error updating color: ' + err.message); } finally { loader.style.display = 'none'; } }
        async function showBackgroundForm() { hideAddChoice(); loader.style.display = 'flex'; try { const doc = await db.collection('siteConfig').doc('main').get(); if (doc.exists) { document.getElementById('backgroundUrlInput').value = doc.data().backgroundUrl || ''; } } catch (err) { console.error("Error fetching background URL:", err); } finally { loader.style.display = 'none'; } switchView('background-form-view'); }
        document.getElementById('background-form').addEventListener('submit', async (e) => { e.preventDefault(); const url = document.getElementById('backgroundUrlInput').value; loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ backgroundUrl: url }, { merge: true }); alert('Background wallpaper updated successfully!'); switchView(lastActiveView); } catch (err) { alert('Error updating background: ' + err.message); } finally { loader.style.display = 'none'; } });
        async function resetBackground() { if (confirm("Are you sure you want to reset the background to the default color?")) { loader.style.display = 'flex'; try { await db.collection('siteConfig').doc('main').set({ backgroundUrl: "" }, { merge: true }); document.getElementById('backgroundUrlInput').value = ""; alert('Background has been reset to default.'); switchView(lastActiveView); } catch (err) { alert('Error resetting background: ' + err.message); } finally { loader.style.display = 'none'; } } }
        function applyThemeColor(hexCode) { if (hexCode) document.documentElement.style.setProperty('--primary', hexCode); }
        async function fetchSiteConfig() { try { const doc = await db.collection('siteConfig').doc('main').get(); if (doc.exists) applyThemeColor(doc.data().primaryColor); } catch (err) { console.error("Error fetching site config:", err); } }
        
        async function fetchCollectionData(collectionName) { 
            const listEl = document.getElementById(`${collectionName}-list`); 
            let query = collectionName === 'updates' ? db.collection(collectionName).orderBy("timestamp", "desc") : db.collection(collectionName).orderBy("title"); 
            try { 
                const snapshot = await query.get(); 
                
                if (collectionName === 'anime') {
                    document.getElementById('anime-stats').innerHTML = `Total Anime: ${snapshot.size}`;
                } else if (collectionName === 'animeBanners') {
                    document.getElementById('banner-stats').innerHTML = `Total Banners: ${snapshot.size}`;
                }

                listEl.innerHTML = ''; 
                if (!snapshot.empty) { 
                    snapshot.forEach(doc => { 
                        const d = doc.data(); 
                        const displayName = d.title || (collectionName === 'updates' ? (d.description || 'No Description').substring(0, 40) + '...' : 'No Title'); 
                        const itemEl = document.createElement('div'); 
                        itemEl.className = 'list-item'; 
                        itemEl.innerHTML = `<span></span><div class="list-item-actions"><button title="Edit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`; 
                        itemEl.querySelector('span').textContent = displayName; 
                        itemEl.querySelector('button[title="Edit"]').onclick = () => openForm(collectionName, 'edit', doc.id); 
                        itemEl.querySelector('button[title="Delete"]').onclick = () => deleteDoc(collectionName, doc.id, displayName); 
                        listEl.appendChild(itemEl); 
                    }); 
                } 
                else { listEl.innerHTML = `<p>No data found.</p>`; } 
            } catch (e) { console.error(e); listEl.innerHTML = `<p>Error loading data.</p>`; } 
        }

        async function deleteDoc(collection, docId, title) { if (confirm(`Delete "${title}"?`)) { await db.collection(collection).doc(docId).delete(); fetchAllData(); } }
        async function fetchSettingsData(collectionName) {
            const listElId = collectionName === 'animeBanners' ? 'banner-settings-list' : 'anime-settings-list';
            const listEl = document.getElementById(listElId);
            try { const snapshot = await db.collection(collectionName).orderBy("title").get(); listEl.innerHTML = '';
                if (!snapshot.empty) { snapshot.forEach(doc => { const d = doc.data(); const currentButtonText = d.buttonText || 'Watch Now'; const itemEl = document.createElement('div'); itemEl.className = 'list-item'; itemEl.innerHTML = `<div class="list-item-details"><span></span><span class="current-btn-text"></span></div><button class="btn-change-text">Change</button>`; itemEl.querySelector('span').textContent = d.title; itemEl.querySelector('.current-btn-text').textContent = `Button: ${currentButtonText}`; itemEl.querySelector('.btn-change-text').onclick = () => changeButtonText(collectionName, doc.id, d.title, currentButtonText); listEl.appendChild(itemEl); }); } 
                else { listEl.innerHTML = `<p>No data found.</p>`; }
            } catch (e) { console.error("Error loading settings:", e); listEl.innerHTML = `<p>Error loading settings data.</p>`; }
        }
        async function changeButtonText(collection, docId, title, currentText) { const newText = prompt(`Enter new button text for "${title}":`, currentText); if (newText && newText.trim() !== '') { loader.style.display = 'flex'; try { await db.collection(collection).doc(docId).update({ buttonText: newText }); fetchSettingsData(collection); } catch (err) { alert('Error updating button text: ' + err.message); } finally { loader.style.display = 'none'; } } }
        function openManageComments() { hideAddChoice(); switchView('manage-comment-view'); fetchCommentableAnime(); }
        async function fetchCommentableAnime() { const listEl = document.getElementById('comment-anime-list'); listEl.innerHTML = '<p>Loading anime...</p>'; try { const snapshot = await db.collection('anime').orderBy('title').get(); if (snapshot.empty) { listEl.innerHTML = '<p>No anime found.</p>'; return; } listEl.innerHTML = ''; snapshot.forEach(doc => { const anime = doc.data(); const card = document.createElement('div'); card.className = 'comment-card'; card.innerHTML = `<img src="${anime.imageUrl}" class="comment-card-poster"><span>${anime.title}</span>`; card.onclick = () => openCommentDetails(doc.id, anime.title); listEl.appendChild(card); }); } catch (err) { listEl.innerHTML = '<p>Error loading anime.</p>'; console.error(err); } }
        function openCommentDetails(animeId, animeTitle) { document.getElementById('comment-anime-title').innerText = animeTitle; const commentsListEl = document.getElementById('comments-list-owner'); commentsListEl.innerHTML = '<p>Loading comments...</p>'; switchView('comment-details-view'); if (currentCommentListener) currentCommentListener(); currentCommentListener = db.collection('anime').doc(animeId).collection('comments').orderBy('timestamp', 'asc').onSnapshot(snapshot => { commentsListEl.innerHTML = ''; if (snapshot.empty) { commentsListEl.innerHTML = '<p>No comments yet.</p>'; return; } snapshot.forEach(doc => { const comment = doc.data(); const item = document.createElement('div'); item.className = 'comment-item'; if(comment.isOwnerReply) item.classList.add('owner'); const author = comment.isOwnerReply ? `<span class="comment-author">Owner <span class="owner-icon">👑</span></span>` : `<span class="comment-author">${comment.name || 'Anonymous'}</span>`; item.innerHTML = `<div class="comment-header">${author}<button class="comment-delete-btn" title="Delete Comment">&times;</button></div><p>${comment.text}</p>`; item.querySelector('.comment-delete-btn').onclick = () => deleteComment(animeId, doc.id); commentsListEl.appendChild(item); }); }); document.getElementById('sendReplyBtn').onclick = () => sendOwnerReply(animeId); }
        async function sendOwnerReply(animeId) { const input = document.getElementById('replyInput'); const text = input.value.trim(); if (text === '') return; try { await db.collection('anime').doc(animeId).collection('comments').add({ text: text, isOwnerReply: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); input.value = ''; } catch (err) { alert('Failed to send reply.'); console.error(err); } }
        async function deleteComment(animeId, commentId) { if (confirm('Delete this comment?')) { try { await db.collection('anime').doc(animeId).collection('comments').doc(commentId).delete(); } catch (err) { alert('Failed to delete comment.'); console.error(err); } } }
        function openManageAdmins() { hideAddChoice(); switchView('manage-admins-view'); fetchAdmins(); }
        async function fetchAdmins() { const listEl = document.getElementById('admins-list'); const statsEl = document.getElementById('admin-stats'); listEl.innerHTML = '<p>Loading admins...</p>'; statsEl.innerHTML = ''; try { const snapshot = await db.collection('admins').get(); const date = new Date().toLocaleDateString('en-GB'); statsEl.innerHTML = `${date}<br>Total Admins: ${snapshot.size}`; if (snapshot.empty) { listEl.innerHTML = '<p>No admins found.</p>'; return; } listEl.innerHTML = ''; snapshot.forEach(doc => { const admin = doc.data(); const itemEl = document.createElement('div'); itemEl.className = 'list-item'; const status = admin.status === 'banned' ? ' (Banned)' : ''; itemEl.innerHTML = `<span>${admin.name}${status}</span><div class="list-item-actions"><button title="Ban/Unban"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m4.93 4.93 14.14 14.14"/></svg></button><button title="Delete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`; itemEl.querySelector('button[title="Ban/Unban"]').onclick = () => toggleBanAdmin(doc.id, admin.name, admin.status); itemEl.querySelector('button[title="Delete"]').onclick = () => deleteAdmin(doc.id, admin.name); listEl.appendChild(itemEl); }); } catch (err) { listEl.innerHTML = '<p>Error loading admins.</p>'; console.error(err); } }
        async function deleteAdmin(adminId, adminName) { if (confirm(`PERMANENTLY DELETE admin "${adminName}"?`)) { await db.collection('admins').doc(adminId).delete(); fetchAdmins(); } }
        async function toggleBanAdmin(adminId, adminName, currentStatus) { const newStatus = currentStatus === 'banned' ? 'active' : 'banned'; const action = newStatus === 'banned' ? 'BAN' : 'UNBAN'; if (confirm(`Are you sure you want to ${action} "${adminName}"?`)) { await db.collection('admins').doc(adminId).update({ status: newStatus }); fetchAdmins(); } }
        function fetchAllData() { fetchSiteConfig(); fetchCollectionData('animeBanners'); fetchCollectionData('anime'); fetchCollectionData('updates'); fetchSettingsData('animeBanners'); fetchSettingsData('anime'); }
        fetchAllData();
    </script>
</body>
    </html>
